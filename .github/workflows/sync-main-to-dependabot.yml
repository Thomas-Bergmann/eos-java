name: Create PR to dependabot-integration from main

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  create-pr-to-dependabot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Check if dependabot-integration branch exists and get diff
        id: check_diff
        run: |
          git fetch origin dependabot-integration:dependabot-integration || echo "dependabot-integration branch not found"
          
          # Check if there are differences between main and dependabot-integration
          if git diff --quiet dependabot-integration..main; then
            echo "No differences found between branches"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes found between branches"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Get commit messages for PR description
            COMMITS=$(git log dependabot-integration..main --oneline --no-merges)
            echo "commits<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request to dependabot-integration
        if: steps.check_diff.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: dependabot-integration
          head: main
          title: "Sync main branch changes to dependabot-integration"
          body: |
            ## Main Branch Sync
            
            This PR syncs the latest changes from `main` branch to `dependabot-integration` to keep the dependency branch up to date.
            
            ### Changes included:
            ```
            ${{ steps.check_diff.outputs.commits }}
            ```
            
            ### Purpose:
            - üîÑ Keep dependabot-integration branch synchronized with main
            - üõ°Ô∏è Ensure dependency updates are applied to the latest codebase
            - üöÄ Maintain clean merge history
            
            ### ‚ö†Ô∏è MERGE STRATEGY: Use "Create a merge commit" (NOT squash)
            
            Auto-generated by GitHub Actions.
          labels: |
            sync
            auto-merge

      - name: Enable auto-merge with merge strategy
        if: steps.check_diff.outputs.has_changes == 'true'
        run: |
          # Get the PR number from the previous step
          PR_URL=$(gh pr list --base dependabot-integration --head main --json url --jq '.[0].url')
          if [ ! -z "$PR_URL" ]; then
            PR_NUMBER=$(echo $PR_URL | grep -o '[0-9]\+$')
            echo "Enabling auto-merge for PR #$PR_NUMBER with merge strategy"
            gh pr merge $PR_NUMBER --auto --merge
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
