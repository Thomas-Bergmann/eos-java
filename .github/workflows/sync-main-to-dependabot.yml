name: Create PR to dependabot-integration from main

on:
  push:
    branches: [ main ]

jobs:
  create-pr-to-dependabot:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Check if dependabot-integration branch exists and get diff
        id: check_diff
        run: |
          git fetch origin dependabot-integration:dependabot-integration || echo "dependabot-integration branch not found"
          
          # Check if there are differences between main and dependabot-integration
          if git diff --quiet dependabot-integration..main; then
            echo "No differences found between branches"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes found between branches"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Get commit messages for PR description
            COMMITS=$(git log dependabot-integration..main --oneline --no-merges)
            echo "commits<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request to dependabot-integration
        if: steps.check_diff.outputs.has_changes == 'true'
        id: create_pr
        run: |
          # Check if a PR already exists
          EXISTING_PR=$(gh pr list --base dependabot-integration --head main --json number --jq '.[0].number // empty')
          
          if [ -z "$EXISTING_PR" ]; then
            # Create new PR
            PR_URL=$(gh pr create \
              --base dependabot-integration \
              --head main \
              --title "Sync main branch changes to dependabot-integration" \
              --body "## Main Branch Sync

            This PR syncs the latest changes from \`main\` branch to \`dependabot-integration\` to keep the dependency branch up to date.

            ### Changes included:
            \`\`\`
            ${{ steps.check_diff.outputs.commits }}
            \`\`\`

            ### Purpose:
            - 🔄 Keep dependabot-integration branch synchronized with main
            - 🛡️ Ensure dependency updates are applied to the latest codebase
            - 🚀 Maintain clean merge history

            ### ⚠️ MERGE STRATEGY: Use \"Create a merge commit\" (NOT squash)

            Auto-generated by GitHub Actions." \
              --label "sync,auto-merge")
            
            echo "Created PR: $PR_URL"
            
            # Extract PR number for auto-merge
            PR_NUMBER=$(echo $PR_URL | grep -o '[0-9]\+$')
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "PR already exists: #$EXISTING_PR"
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge with merge strategy
        if: steps.check_diff.outputs.has_changes == 'true' && steps.create_pr.outputs.pr_number
        run: |
          echo "Enabling auto-merge for PR #${{ steps.create_pr.outputs.pr_number }} with merge strategy"
          gh pr merge ${{ steps.create_pr.outputs.pr_number }} --auto --merge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
