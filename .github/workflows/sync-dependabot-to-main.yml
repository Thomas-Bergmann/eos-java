name: Create PR to main from dependabot-integration

on:
  schedule:
    - cron: '0 8 * * 1'  # Weekly on Mondays at 8:00 AM UTC
  workflow_dispatch:

jobs:
  create-pr-to-main:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout dependabot-integration
        uses: actions/checkout@v4
        with:
          ref: dependabot-integration
          fetch-depth: 0

      - name: Check if main branch exists and get diff
        id: check_diff
        run: |
          git fetch origin main:main || echo "main branch not found"
          
          # Check if there are differences between dependabot-integration and main
          if git diff --quiet main..dependabot-integration; then
            echo "No differences found between branches"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes found between branches"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Get commit messages for PR description
            COMMITS=$(git log main..dependabot-integration --oneline --no-merges)
            echo "commits<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request to main
        if: steps.check_diff.outputs.has_changes == 'true'
        run: |
          # Check if a PR already exists
          EXISTING_PR=$(gh pr list --base main --head dependabot-integration --json number --jq '.[0].number // empty')
          
          if [ -z "$EXISTING_PR" ]; then
            # Create new PR
            PR_URL=$(gh pr create \
              --base main \
              --head dependabot-integration \
              --title "Sync dependency updates from dependabot-integration to main" \
              --body "## Dependency Updates Sync

            This PR syncs the latest dependency updates from \`dependabot-integration\` branch to \`main\`.

            ### Changes included:
            \`\`\`
            ${{ steps.check_diff.outputs.commits }}
            \`\`\`

            ### Review Guidelines:
            - ✅ All tests should pass
            - ✅ Review any breaking changes in dependencies
            - ✅ Check for security updates

            ### ⚠️ MERGE STRATEGY: Use \"Create a merge commit\" (NOT squash)

            **⚠️ This PR requires manual approval and merge.**

            Auto-generated by GitHub Actions." \
              --label "dependencies,sync,needs-review")
            
            echo "Created PR: $PR_URL"
          else
            echo "PR already exists: #$EXISTING_PR"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
