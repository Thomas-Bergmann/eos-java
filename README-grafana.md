# EOS Grafana Monitoring Setup

This setup allows you to visualize your Energy System Simulation (EOS) results in Grafana using InfluxDB as the time-series database.

## Quick Start

### 1. Start Monitoring Stack

```bash
# Start Grafana and InfluxDB
docker-compose up -d

# Check services are running
docker-compose ps
```

### 2. Access Services

- **Grafana**: http://localhost:3000 (admin/admin123)
- **InfluxDB**: http://localhost:8086 (admin/password123)

### 3. Run Simulation with Metrics Export

```bash
# Run the metrics export test
./gradlew test --tests "*MetricsExportTest*"
```

### 4. View Dashboard

1. Open Grafana: http://localhost:3000
2. Login: admin/admin123
3. Navigate to **Dashboards > Energy System Simulation (EOS)**
4. View your simulation data in real-time!

## Dashboard Panels

The dashboard includes main visualizations organized in a comprehensive layout:

### ðŸ’° Cumulative Energy Costs Summary (EUR)
Stat panel displaying cumulative totals:
- **Net Costs**: Overall profit/loss from grid operations
- **Import Costs**: Total money spent on grid imports
- **Export Revenue**: Total money earned from grid exports

### âš¡ Grid Transfer (kWh)
Line chart focusing on grid interactions:
- **Grid Import** (orange): Energy purchased from grid
- **Grid Export** (purple): Energy sold to grid

### ðŸ“Š Energy Flow (kWh)
Stacked bar chart showing all energy flows:
- **Production** (blue): Energy generated by solar panels with panel efficiency
- **Consumption** (red): Total energy consumed by devices  
- **Charged** (green): Energy stored in batteries
- **Battery Discharged** (green): Energy released from batteries
- **Imported** (purple): Energy purchased from grid
- **Exported** (purple): Energy sold to grid

### ðŸ“ˆ Energy Price (/kWh)
Line chart displaying real-time or static energy pricing:
- **Import Price** (EUR/kWh): Current price for importing energy (displayed as costs)
- **Export Price** (EUR/kWh): Current price for exporting energy back to grid

### ðŸ”‹ Battery Storage (kWh)
**Stacked** area chart showing stored energy levels:
- **Battery Storage Level** (light-blue): Energy stored in all batteries over time

### ðŸš— Electric Car Battery (%)
Line chart showing car battery charge levels:
- **Storage Percentage**: Charge level of electric car batteries as percentage

### âš¡ Energy Costs Timeline (EUR)
Line chart showing cost flows over time:
- **Import** (red): Hourly costs for importing energy
- **Export** (blue): Hourly revenue from exporting energy


## Configuration

### InfluxDB Settings

Edit `devices/src/main/resources/application.properties`:

```properties
# InfluxDB Metrics Configuration
eos.metrics.influxdb.enabled=true
eos.metrics.influxdb.url=http://localhost:8086
eos.metrics.influxdb.token=eos-token-12345678901234567890
eos.metrics.influxdb.org=eos
eos.metrics.influxdb.bucket=energy_simulation
```

### Simulation Configuration

Your simulation uses the test configuration with:
- **13 Solar Panels**: 0.45 kW each with 92% inverter efficiency
- **3 Batteries**: 3.0 kWh each with 85% charge/discharge efficiency
- **1 Electric Car**: 50 kWh capacity with 90% charging limit
- **1 Grid Connection**: German residential pricing (39Â¢ import, 8Â¢ export) or dynamic

## Simulation Scenarios

The system simulates realistic scenarios including:

1. **Solar Production**: Variable based on weather and panel efficiency
2. **Battery Management**: Smart charging/discharging with efficiency losses
3. **Electric Car Charging**: Configurable charging schedules and V2G support
4. **Grid Operations**: Import/export with cost optimization
5. **Storage Losses**: Daily self-discharge simulation

## Technical Details

### Metrics Exported

**Energy Flow Metrics** (`energy_flow` measurement):
- tag: `simulation` simulation id
- `produced_kwh`: Solar energy production
- `consumed_kwh`: Total energy consumption
- `charged_kwh`: Battery charging energy
- `discharged_kwh`: Battery discharging energy
- `imported_kwh`: Grid import energy
- `exported_kwh`: Grid export energy

**Energy Cost Metrics** (`energy_costs` measurement):
- tag: `simulation` simulation id
- `grid_import_eur`: Money spent on grid imports per time step
- `grid_export_eur`: Money earned from grid exports per time step
- `grid_net_eur`: Net cost/profit from grid operations per time step

**Battery Storage Metrics** (`battery_storage` measurement):
- tag: `simulation` simulation id
- tag: `type` (BATTERY, ELECTRIC_CAR),
- tag: `device` (device identifier)
- `stored_energy_kwh`: Energy stored in individual batteries (by device)
- `storage_percentage`: Battery charge level as percentage (0.0-1.0)

**Energy Price Forecast** (`forecast_price` measurement):
- `import_price_eur`: Current import energy price (EUR/kWh)
- `export_price_eur`: Current export energy price (EUR/kWh)

### Data Flow

1. **Simulation** â†’ Generate energy flow data
2. **Metrics Exporter** â†’ Send data to InfluxDB
3. **InfluxDB** â†’ Store time-series data
4. **Grafana** â†’ Visualize and analyze data

## Troubleshooting

### Services Not Starting
```bash
# Check logs
docker-compose logs grafana
docker-compose logs influxdb

# Restart services
docker-compose restart
```

### No Data in Grafana
1. Verify InfluxDB connection in Grafana datasources
2. Check that the metrics export test ran successfully
3. Ensure InfluxDB token matches in configuration

### Dashboard Issues
1. Check InfluxDB datasource is connected
2. Verify bucket name matches configuration
3. Refresh dashboard or adjust time range
4. Remember stacked visualization

## Stopping Services

```bash
# Stop services
docker-compose down

# Stop and remove all data
docker-compose down -v
```

## Next Steps

- Integrate with real IoT devices for live monitoring
